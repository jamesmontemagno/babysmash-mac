name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  SCHEME: babysmash
  PRODUCT_NAME: BabySmash
  SPARKLE_VERSION: "2.8.1"

jobs:
  build-and-release:
    runs-on: macos-15
    environment: ci
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'
          
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
            
      - name: Install Apple Developer ID certificate
        env:
          DEVELOPER_ID_CERTIFICATE_BASE64: ${{ secrets.DEVELOPER_ID_CERTIFICATE_BASE64 }}
          DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Import certificate from secrets
          echo -n "$DEVELOPER_ID_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$DEVELOPER_ID_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme ${{ env.SCHEME }}
      
      - name: Set Version Numbers
        run: |
          # Extract version from tag (remove 'v' prefix)
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          
          # Use GitHub run number as build number for auto-increment
          BUILD_NUMBER="${{ github.run_number }}"
          
          echo "Setting MARKETING_VERSION to: $VERSION"
          echo "Setting CURRENT_PROJECT_VERSION to: $BUILD_NUMBER"
          
          # Update Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" babysmash/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" babysmash/Info.plist
          
          # Also export for use in build step
          echo "MARKETING_VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
            
      - name: Build and Archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Build archive
          xcodebuild archive \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -configuration Release \
            -archivePath $RUNNER_TEMP/${{ env.PRODUCT_NAME }}.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM=$APPLE_TEAM_ID \
            MARKETING_VERSION=${{ env.MARKETING_VERSION }} \
            CURRENT_PROJECT_VERSION=${{ env.BUILD_NUMBER }} \
            -allowProvisioningUpdates
            
      - name: Export Archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create export options plist
          cat > $RUNNER_TEMP/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>teamID</key>
              <string>$APPLE_TEAM_ID</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Developer ID Application</string>
          </dict>
          </plist>
          EOF
          
          # Export the archive
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/${{ env.PRODUCT_NAME }}.xcarchive \
            -exportPath $RUNNER_TEMP/Export \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist
            
      - name: Notarize App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create ZIP for notarization
          ditto -c -k --sequesterRsrc --keepParent \
            "$RUNNER_TEMP/Export/${{ env.SCHEME }}.app" \
            "$RUNNER_TEMP/${{ env.PRODUCT_NAME }}-notarize.zip"
          
          # Submit for notarization and wait
          xcrun notarytool submit "$RUNNER_TEMP/${{ env.PRODUCT_NAME }}-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          
          # Staple the notarization ticket
          xcrun stapler staple "$RUNNER_TEMP/Export/${{ env.SCHEME }}.app"
          
      - name: Create Distribution ZIP
        run: |
          # Create final distribution ZIP
          ditto -c -k --sequesterRsrc --keepParent \
            "$RUNNER_TEMP/Export/${{ env.SCHEME }}.app" \
            "$RUNNER_TEMP/${{ env.PRODUCT_NAME }}-${{ github.ref_name }}.zip"
            
      - name: Verify Signature
        run: |
          spctl -a -vv "$RUNNER_TEMP/Export/${{ env.SCHEME }}.app"
          codesign -dvv "$RUNNER_TEMP/Export/${{ env.SCHEME }}.app"
          
      - name: Download Sparkle
        run: |
          curl -L -o $RUNNER_TEMP/Sparkle.tar.xz \
            "https://github.com/sparkle-project/Sparkle/releases/download/${{ env.SPARKLE_VERSION }}/Sparkle-${{ env.SPARKLE_VERSION }}.tar.xz"
          mkdir -p $RUNNER_TEMP/Sparkle
          tar -xf $RUNNER_TEMP/Sparkle.tar.xz -C $RUNNER_TEMP/Sparkle
          
      - name: Generate Appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Create directory for release files
          mkdir -p $RUNNER_TEMP/release-files
          cp "$RUNNER_TEMP/${{ env.PRODUCT_NAME }}-${{ github.ref_name }}.zip" $RUNNER_TEMP/release-files/
          
          # Save private key to file
          echo "$SPARKLE_PRIVATE_KEY" > $RUNNER_TEMP/sparkle_private_key
          
          # Generate appcast with Sparkle tools
          $RUNNER_TEMP/Sparkle/bin/generate_appcast \
            --ed-key-file $RUNNER_TEMP/sparkle_private_key \
            --download-url-prefix "https://github.com/jamesmontemagno/babysmash-mac/releases/download/${{ github.ref_name }}/" \
            $RUNNER_TEMP/release-files
          
          # Move generated appcast
          mv $RUNNER_TEMP/release-files/appcast.xml $RUNNER_TEMP/appcast.xml
          
          # Clean up private key
          rm -f $RUNNER_TEMP/sparkle_private_key
          
      - name: Embed Release Notes in Appcast
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get release notes from GitHub release (will be created in next step)
          # For now, use the tag message or generate placeholder
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }} || echo "")
          
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE="Release ${{ github.ref_name }}"
          fi
          
          # The appcast already contains the item from generate_appcast
          # We could enhance this to embed release notes as CDATA in description
          echo "Release notes: $TAG_MESSAGE"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ runner.temp }}/${{ env.PRODUCT_NAME }}-${{ github.ref_name }}.zip
            ${{ runner.temp }}/release-files/*.delta
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Deploy Appcast to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: ./
          keep_files: true
          
      - name: Update docs/appcast.xml
        run: |
          # Copy generated appcast to docs folder
          cp $RUNNER_TEMP/appcast.xml docs/appcast.xml
          
      - name: Commit Updated Appcast
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update appcast.xml for ${{ github.ref_name }}"
          file_pattern: docs/appcast.xml
          branch: main
          
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
